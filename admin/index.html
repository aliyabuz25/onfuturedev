<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OnFuture Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f4f6f9;
            padding: 40px;
        }

        .card {
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .form-label {
            font-weight: 500;
            color: #495057;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1055;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>OnFuture Admin</h1>
            <button class="btn btn-primary" onclick="saveContent()">Save Changes</button>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card p-4">
                    <h4 class="mb-3">Text Content</h4>
                    <div id="content-fields">
                        <!-- Dynamic fields will be injected here -->
                        <div class="text-center text-muted">Loading content...</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-4">
                    <h4 class="mb-3">Upload Assets</h4>
                    <div class="mb-3">
                        <label class="form-label">Select Image</label>
                        <input type="file" id="fileInput" class="form-control">
                    </div>
                    <button class="btn btn-secondary w-100" onclick="uploadFile()">Upload</button>
                    <div id="upload-result" class="mt-3 text-break text-muted small"></div>
                </div>
                <div class="card p-4">
                    <h4 class="mb-3">Instructions</h4>
                    <p class="small text-muted">
                        Double-click text on the main website to see the key name, then edit it here.
                        <br><br>
                        Uploaded images will return a URL you can use in content fields.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container"></div>

    <script>
        let currentContent = {};

        async function fetchContent() {
            try {
                const res = await fetch('/api/content');
                currentContent = await res.json();
                renderFields();
            } catch (e) {
                showToast('Error', 'Failed to load content', 'danger');
            }
        }

        function renderFields() {
            const container = document.getElementById('content-fields');
            container.innerHTML = '';

            if (Object.keys(currentContent).length === 0) {
                container.innerHTML = '<p class="text-muted">No content keys found. Content file might be empty.</p>';
                return;
            }

            for (const [key, value] of Object.entries(currentContent)) {
                const wrapper = document.createElement('div');
                wrapper.className = 'mb-3';

                const label = document.createElement('label');
                label.className = 'form-label';
                label.innerText = key;

                const input = document.createElement('textarea'); // Using textarea for multiline support
                input.className = 'form-control';
                input.rows = 2;
                input.value = value;
                input.onchange = (e) => {
                    currentContent[key] = e.target.value;
                };

                wrapper.appendChild(label);
                wrapper.appendChild(input);
                container.appendChild(wrapper);
            }
        }

        async function saveContent() {
            try {
                const res = await fetch('/api/content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentContent)
                });
                if (res.ok) {
                    showToast('Success', 'Content saved successfully!', 'success');
                } else {
                    throw new Error('Save failed');
                }
            } catch (e) {
                showToast('Error', 'Failed to save changes.', 'danger');
            }
        }

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files.length) return alert('Select a file first');

            const file = fileInput.files[0];

            // Use raw binary upload as per server.js implementation plan
            // POST /api/upload?name=filename
            try {
                const res = await fetch(`/api/upload?name=${encodeURIComponent(file.name)}`, {
                    method: 'POST',
                    body: file
                });
                const data = await res.json();

                if (res.ok) {
                    document.getElementById('upload-result').innerHTML = `Saved at: <code>${data.url}</code> (Copy this!)`;
                    showToast('Success', 'Image uploaded!', 'success');
                } else {
                    throw new Error(data.error || 'Upload failed');
                }
            } catch (e) {
                showToast('Error', 'Upload failed: ' + e.message, 'danger');
            }
        }

        function showToast(title, message, type = 'info') {
            const container = document.querySelector('.toast-container');
            const id = 'toast-' + Date.now();
            const html = `
            <div id="${id}" class="toast align-items-center text-bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <strong>${title}</strong>: ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
            container.insertAdjacentHTML('beforeend', html);
            const toastEl = document.getElementById(id);
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
            toastEl.addEventListener('hidden.bs.toast', () => {
                toastEl.remove();
            });
        }

        fetchContent();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>